<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Histology - Veterinary Colon</title>
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: radial-gradient(circle at center, #0a0a0a, #000);
      color: white;
      overflow: hidden;
    }

    canvas#bgCanvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -2;
      width: 100%;
      height: 100%;
    }

    /* منطقة عرض الموديل */
    #viewer {
      width: 70vw;
      height: 90vh;
      margin: 5vh auto;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 0 40px rgba(180, 100, 255, 0.3);
      background: rgba(255, 255, 255, 0.05);
    }

    /* القوائم الجانبية */
    #leftPanel, #rightPanel {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      width: 260px;
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 15px;
      backdrop-filter: blur(15px);
      box-shadow: 0 0 15px rgba(190, 120, 255, 0.2);
      transition: all 0.3s;
      max-height: 85vh;
      overflow-y: auto;
    }

    #leftPanel { left: 20px; }
    #rightPanel { right: 20px; }

    #leftPanel h3, #rightPanel h3 {
      color: #d5aaff;
      text-align: center;
      margin-top: 0;
    }

    .part-btn {
      display: block;
      width: 100%;
      text-align: center;
      margin: 6px 0;
      padding: 8px;
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .part-btn:hover {
      background: rgba(200, 150, 255, 0.3);
      transform: scale(1.05);
      color: #ffe6ff;
    }

    #bottomBar {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 25px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      padding: 10px 25px;
      box-shadow: 0 0 15px rgba(180, 100, 255, 0.3);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .icon-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.3s, color 0.3s;
    }

    .icon-btn:hover {
      transform: scale(1.2);
      color: #dcaeff;
    }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <!-- لوحة الشرح العام -->
  <div id="leftPanel">
    <h3>🔬 شرح الموديل بالكامل</h3>
    <p>
      هذا النموذج ثلاثي الأبعاد يمثل القولون في الحيوان، 
      ويهدف لتوضيح الطبقات النسيجية المختلفة 
      مثل الطبقة الطلائية، الطبقة العضلية، والنسيج الضام.
      يمكن الضغط على أي جزء من القائمة اليمنى لاستعراض تفاصيله النسيجية.
    </p>
  </div>

  <!-- لوحة أسماء الأجزاء -->
  <div id="rightPanel">
    <h3>🧠 أجزاء الموديل</h3>
    <div id="partsList">جاري التحميل...</div>
  </div>

  <!-- مشهد العرض -->
  <div id="viewer"></div>

  <!-- الشريط السفلي -->
  <div id="bottomBar">
    <button class="icon-btn" onclick="resetCamera()">🔄</button>
    <button class="icon-btn" onclick="highlightRandom()">✨</button>
    <button class="icon-btn" onclick="goToMicroscop()">🔬</button>
  </div>

  <!-- مكتبات Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    let scene, camera, renderer, controls, model;
    const viewer = document.getElementById("viewer");
    const partsList = document.getElementById("partsList");

    init();
    loadModel();
    animateBackground();

    function init() {
      scene = new THREE.Scene();

      // كاميرا أبعد شوية
      camera = new THREE.PerspectiveCamera(60, viewer.clientWidth / viewer.clientHeight, 0.1, 1000);
      camera.position.set(0, 1, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(viewer.clientWidth, viewer.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      viewer.appendChild(renderer.domElement);

      // إضاءة خفيفة ومتوازنة
      const ambient = new THREE.AmbientLight(0xffffff, 0.5);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
      dirLight.position.set(4, 4, 6);
      scene.add(ambient, dirLight);

      // تحكم ودوران تلقائي بطيء
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.autoRotate = true;
      controls.autoRotateSpeed = 0.3;
      controls.enableZoom = true;

      window.addEventListener("resize", onWindowResize);
    }

    function loadModel() {
      const loader = new THREE.GLTFLoader();
      loader.load(
        "colon.glb",
        (gltf) => {
          model = gltf.scene;
          scene.add(model);

          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          model.position.sub(center);
          model.scale.setScalar(1.1);

          generatePartsList(model);
          animate();
        },
        undefined,
        (err) => console.error("خطأ تحميل الموديل:", err)
      );
    }

    const partDescriptions = {
      Colon: "القولون يحتوي على خلايا عمودية تمتص الماء وتشكل السطح الداخلي.",
      Sigmoid: "الجزء السيني يحتوي على خلايا مخاطية لتسهيل حركة الفضلات.",
      Rectum: "المستقيم يحتوي على خلايا عضلية تساعد في عملية الإخراج.",
      Cecum: "الأعور يحتوي على تجمعات نسيجية مناعية (MALT)."
    };

    function generatePartsList(model) {
      const meshes = [];
      model.traverse(c => c.isMesh && !c.name.toLowerCase().includes("object") && meshes.push(c));
      partsList.innerHTML = "";
      meshes.forEach(m => {
        const btn = document.createElement("button");
        btn.className = "part-btn";
        btn.textContent = m.name;
        btn.onclick = () => {
          highlightPart(m);
          showPartInfo(m);
        };
        partsList.appendChild(btn);
      });
    }

    function highlightPart(mesh) {
      model.traverse(c => { if (c.isMesh) c.material.emissive = new THREE.Color(0x000000); });
      mesh.material.emissive = new THREE.Color(0xff77ff);
    }

    function showPartInfo(mesh) {
      const desc = partDescriptions[mesh.name] || `لا توجد بيانات هستولوجية لـ ${mesh.name}`;
      alert(`🧫 ${mesh.name}\n\n${desc}`);
    }

    function resetCamera() {
      controls.reset();
    }

    function highlightRandom() {
      const meshes = [];
      model.traverse(c => c.isMesh && meshes.push(c));
      const chosen = meshes[Math.floor(Math.random() * meshes.length)];
      highlightPart(chosen);
    }

    function goToMicroscop() {
      window.open("https://histologyguide.com/slideview/MH-123-colon/14-slide-1.html", "_blank");
    }

    function onWindowResize() {
      camera.aspect = viewer.clientWidth / viewer.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(viewer.clientWidth, viewer.clientHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    function animateBackground() {
      const canvas = document.getElementById("bgCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const bubbles = Array.from({ length: 15 }, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: 10 + Math.random() * 25,
        dx: (Math.random() - 0.5) * 0.3,
        dy: (Math.random() - 0.5) * 0.3,
        color: `rgba(180, 120, 255, 0.15)`
      }));

      function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let b of bubbles) {
          ctx.beginPath();
          ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
          ctx.fillStyle = b.color;
          ctx.fill();
          b.x += b.dx;
          b.y += b.dy;
          if (b.x < 0 || b.x > canvas.width) b.dx *= -1;
          if (b.y < 0 || b.y > canvas.height) b.dy *= -1;
        }
        requestAnimationFrame(loop);
      }
      loop();
    }
  </script>
</body>
</html>
